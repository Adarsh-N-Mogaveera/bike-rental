{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/adarsh/Documents/Arjun%27s%20Project/vehicle-rental/app/api/rents/route.js"],"sourcesContent":["// app/api/rents/route.js\r\nimport pool from '../../../../lib/db';\r\nimport { genId, computeHours } from '../../../../lib/utils';\r\n\r\n// GET all rents (joined)\r\nexport async function GET() {\r\n  const [rows] = await pool.query(`\r\n    SELECT r.*, c.name AS customer_name, b.model_name AS bike_model, b.rent_per_hour\r\n    FROM Rent r\r\n    JOIN Customer c ON r.cust_id = c.cust_id\r\n    JOIN Bike b ON r.bike_id = b.bike_id\r\n    ORDER BY r.start_date DESC\r\n  `);\r\n  return new Response(JSON.stringify(rows), { status: 200 });\r\n}\r\n\r\n// POST create booking (transaction-safe)\r\nexport async function POST(req) {\r\n  const conn = await pool.getConnection();\r\n  try {\r\n    const body = await req.json();\r\n    const rental_id = body.rental_id || genId('R');\r\n    const { bike_id, start_date, end_date, cust } = body;\r\n    if (!bike_id || !start_date || !end_date || !cust || !cust.cust_id) {\r\n      return new Response(JSON.stringify({ error: 'missing bike_id/start_date/end_date/cust.cust_id' }), { status: 400 });\r\n    }\r\n\r\n    await conn.beginTransaction();\r\n\r\n    // lock the bike row\r\n    const [bikeRows] = await conn.query('SELECT * FROM Bike WHERE bike_id = ? FOR UPDATE', [bike_id]);\r\n    if (bikeRows.length === 0) throw new Error('Bike not found');\r\n    const bike = bikeRows[0];\r\n    if (bike.status !== 'Available') throw new Error(`Bike not available (status=${bike.status})`);\r\n\r\n    // ensure customer exists\r\n    const [custRows] = await conn.query('SELECT * FROM Customer WHERE cust_id = ?', [cust.cust_id]);\r\n    if (custRows.length === 0) {\r\n      await conn.query('INSERT INTO Customer (cust_id, name, phone, email, address) VALUES (?, ?, ?, ?, ?)', [cust.cust_id, cust.name, cust.phone, cust.email, cust.address]);\r\n    }\r\n\r\n    // compute hours & amount\r\n    const total_hours = computeHours(start_date, end_date);\r\n    const total_amount = (Number(bike.rent_per_hour) * total_hours).toFixed(2);\r\n\r\n    // insert rent\r\n    await conn.query('INSERT INTO Rent (rental_id, cust_id, bike_id, start_date, end_date, total_hours, total_amount) VALUES (?, ?, ?, ?, ?, ?, ?)',\r\n      [rental_id, cust.cust_id, bike_id, start_date, end_date, total_hours, total_amount]);\r\n\r\n    // update bike status to Rented\r\n    await conn.query('UPDATE Bike SET status = ? WHERE bike_id = ?', ['Rented', bike_id]);\r\n\r\n    await conn.commit();\r\n    return new Response(JSON.stringify({ message: 'Booking created', rental_id, total_hours, total_amount }), { status: 201 });\r\n  } catch (err) {\r\n    await conn.rollback();\r\n    return new Response(JSON.stringify({ error: err.message }), { status: 400 });\r\n  } finally {\r\n    conn.release();\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,yBAAyB;;;;;;;;;;;;;;;;;;;AAKlB,eAAe;IACpB,MAAM,CAAC,KAAK,GAAG,MAAM,KAAK,KAAK,CAAC,CAAC;;;;;;EAMjC,CAAC;IACD,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC,OAAO;QAAE,QAAQ;IAAI;AAC1D;AAGO,eAAe,KAAK,GAAG;IAC5B,MAAM,OAAO,MAAM,KAAK,aAAa;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,YAAY,KAAK,SAAS,IAAI,MAAM;QAC1C,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG;QAChD,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,YAAY,CAAC,QAAQ,CAAC,KAAK,OAAO,EAAE;YAClE,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;gBAAE,OAAO;YAAmD,IAAI;gBAAE,QAAQ;YAAI;QACnH;QAEA,MAAM,KAAK,gBAAgB;QAE3B,oBAAoB;QACpB,MAAM,CAAC,SAAS,GAAG,MAAM,KAAK,KAAK,CAAC,mDAAmD;YAAC;SAAQ;QAChG,IAAI,SAAS,MAAM,KAAK,GAAG,MAAM,IAAI,MAAM;QAC3C,MAAM,OAAO,QAAQ,CAAC,EAAE;QACxB,IAAI,KAAK,MAAM,KAAK,aAAa,MAAM,IAAI,MAAM,CAAC,2BAA2B,EAAE,KAAK,MAAM,CAAC,CAAC,CAAC;QAE7F,yBAAyB;QACzB,MAAM,CAAC,SAAS,GAAG,MAAM,KAAK,KAAK,CAAC,4CAA4C;YAAC,KAAK,OAAO;SAAC;QAC9F,IAAI,SAAS,MAAM,KAAK,GAAG;YACzB,MAAM,KAAK,KAAK,CAAC,sFAAsF;gBAAC,KAAK,OAAO;gBAAE,KAAK,IAAI;gBAAE,KAAK,KAAK;gBAAE,KAAK,KAAK;gBAAE,KAAK,OAAO;aAAC;QACxK;QAEA,yBAAyB;QACzB,MAAM,cAAc,aAAa,YAAY;QAC7C,MAAM,eAAe,CAAC,OAAO,KAAK,aAAa,IAAI,WAAW,EAAE,OAAO,CAAC;QAExE,cAAc;QACd,MAAM,KAAK,KAAK,CAAC,gIACf;YAAC;YAAW,KAAK,OAAO;YAAE;YAAS;YAAY;YAAU;YAAa;SAAa;QAErF,+BAA+B;QAC/B,MAAM,KAAK,KAAK,CAAC,gDAAgD;YAAC;YAAU;SAAQ;QAEpF,MAAM,KAAK,MAAM;QACjB,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,SAAS;YAAmB;YAAW;YAAa;QAAa,IAAI;YAAE,QAAQ;QAAI;IAC1H,EAAE,OAAO,KAAK;QACZ,MAAM,KAAK,QAAQ;QACnB,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC,IAAI;YAAE,QAAQ;QAAI;IAC5E,SAAU;QACR,KAAK,OAAO;IACd;AACF"}}]
}